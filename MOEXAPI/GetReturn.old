namespace FinCalc.MOEXAPI
{
	public static partial class GetValues
	{
		public static async Task<Dictionary<string, double>> GetReturns(string marketType, string assetSecid, int pastYears)
        {
			DateTime periodBeginning = DateTime.Today.AddYears(-pastYears);
			
			string url = $"https://iss.moex.com/iss/engines/stock/markets/shares/securities/{assetSecid}/candles.json?from={periodBeginning:yyyy-MM-dd}&interval=7&iss.reverse=true";
			string response = await HttpClient.GetStringAsync(url);
			JsonNode? json = JsonNode.Parse(response)["candles"]["data"] ?? throw new Exception("moex api error");
            
			Dictionary<string, double> result = [];
			for (int i = 0; i < json.AsArray().Count; i++)
            {
				double priceChange = json[i][1].GetValue<double>() / json[i][0].GetValue<double>();//[1] - close price, [0] - open
				//[7]end date
                result[json[i][7].GetValue<string>()] = priceChange;
            }
			return result;
        }

		public static async Task<double> GetReturn(string marketType, string assetSecid, int pastYears)
		{
			//search lmited to engine=stock and market=shares
			string url = $"https://iss.moex.com/iss/engines/stock/markets/shares/securities/{assetSecid}/candles.json?interval=4&iss.reverse=true";
			string response = await HttpClient.GetStringAsync(url);
			JsonNode? json = JsonNode.Parse(response)["candles"]["data"] ?? throw new Exception("moex api error");

			double result = CalculateReturn(json, pastYears);

			return result;
		}
		
		private static double CalculateReturn(JsonNode json, int pastYears)
		{
			int daysInYear = DateTime.IsLeapYear(DateTime.Today.Year) ? 366 : 365;
			int daysElapsed = (DateTime.Today - new DateTime(DateTime.Today.Year, 1, 1)).Days + 1;

			int firstQuarterIndex = GetFirstQuarterIndex(json);

			double currentYearPriceChange = json[0][1].GetValue<double>() / json[firstQuarterIndex][0].GetValue<double>();
			
			//annualize current year price change
			double totalGrowth = Math.Pow(1 + currentYearPriceChange, daysInYear / daysElapsed) - 1;
			
			//CAGR
			for (int i = 0; i < pastYears; i++)
			{
				double previousYearPriceChange = json[firstQuarterIndex + 1][1].GetValue<double>() / json[firstQuarterIndex + 4][0].GetValue<double>();
				totalGrowth *= 1 + previousYearPriceChange;
			}
			double cagr = Math.Pow(totalGrowth, 1 / (pastYears + 1)) - 1;
			
			return cagr;

			//TO DO
			//add handle in case not enough periods
		}

		private static int GetFirstQuarterIndex(JsonNode json)
		{
			for (int i = 0; i < 4; i++)
			{
				if (json[i][6].GetValue<string>().Split('-')[1] == "01") return i;
				//json[i][6] - [6] stands for "begin" datetime value; Split('-')[1] gets month value from datetime string of form "yyyy-MM-dd 00:00:00"
			}

			throw new Exception("Error in received data: First qurter wasn't found");
		}
	}
}


/*

		public static async Task<double> GetReturn(Asset asset)
		{
			string url = $"https://iss.moex.com/iss/engines/stock/markets/shares/securities/{asset.Secid}/candles.json?interval=4&iss.reverse=true";
			
			string response = await client.GetStringAsync(url);
			JsonNode? json = JsonNode.Parse(response);
			JsonNode? candlesData = json?["candles"]?["data"];
			double latestPrice = candlesData[0][1].GetValue<double>();
			double yearAgoPrice = candlesData[3][0].GetValue<double>(); //add handle in case not enough periods
			double priceChange = (latestPrice - yearAgoPrice) / yearAgoPrice;

			return priceChange;
		}
		public static async Task<double> GetReturnOnMarket()
		{
			string today = DateTime.Today.ToString("yyyy-MM-dd");
			string oneYearAgo = DateTime.Today.AddYears(-1).ToString("yyyy-MM-dd");

			string url = $"https://iss.moex.com/iss/engines/stock/markets/index/securities/IMOEX/candles.json?interval=4&iss.reverse=true&from={oneYearAgo}";
			string response = await client.GetStringAsync(url);
			JsonNode? json = JsonNode.Parse(response)["candles"]["data"];
			double lastValue = json[0][1].GetValue<double>(); //close prise in last year
			double previousValue = json[3][0].GetValue<double>(); //open prise in previous year
			
			return lastValue / previousValue;
		}


*/